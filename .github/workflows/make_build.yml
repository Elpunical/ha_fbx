name: Make test build

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Install required packages
        run: |
          export TERM=linux
          sudo apt-get update
          sudo apt-get install kpartx qemu-user-static qemu-utils
      - name: Packer setup ${{ env.VERSION }}
        run: |
          DEB_IMG="https://cloud.debian.org/images/cloud/buster/20200210-166/debian-10-generic-arm64-20200210-166.qcow2"
          UBU_IMG="https://cloud-images.ubuntu.com/eoan/current/eoan-server-cloudimg-arm64.img"
          PACKER_VERSION="1.5.4"
          curl https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o /tmp/packer.zip
          unzip /tmp/packer.zip -d /tmp
          sudo mv /tmp/packer /usr/bin/packer
          git clone https://github.com/solo-io/packer-builder-arm-image /tmp/packer-builder-arm-image
          cd /tmp/packer-builder-arm-image && go get -d ./... && go build
          sudo cp /tmp/packer-builder-arm-image/packer-builder-arm-image /usr/bin
          curl ${UBU_IMG} -o /tmp/arm64.qcow2
          qemu-img convert /tmp/arm64.qcow2 /home/runner/work/ha_fbx/arm64.img
          #curl ${UBU_IMG} -o /home/runner/work/ha_fbx/arm64.img
      - name: Build image ${{ env.VERSION }}
        run: |
          mkdir -p /tmp/mnt
          cd tasks && sudo /usr/bin/packer build ha_fbx_arm64.json
      - name: Clean
        run: |
          echo "Build done"
