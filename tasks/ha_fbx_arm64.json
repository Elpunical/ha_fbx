{
    "variables": {
        "img_mount_path": "{{user `init_path`}}/mnt",
        "playbook": "ha_fbx.yml"
    },
    "builders": [
        {
            "name": "hafbx",
            "type": "arm-image",
            "chroot_mounts": [
                [
                    "proc",
                    "proc",
                    "/proc"
                ],
                [
                    "sysfs",
                    "sysfs",
                    "/sys"
                ],
                [
                    "bind",
                    "/dev",
                    "/dev"
                ],
                [
                    "devpts",
                    "devpts",
                    "/dev/pts"
                ],
                [
                    "binfmt_misc",
                    "binfmt_misc",
                    "/proc/sys/fs/binfmt_misc"
                ]
            ],
            "image_type": "raspberrypi",
            "image_mounts": [
                "/",
                "/boot/efi"
            ],
            "iso_url": "{{user `init_path`}}/arm64.img",
            "iso_checksum_type": "none",
            "mount_path": "{{ user `img_mount_path` }}",
            "qemu_binary": "qemu-aarch64-static"
        }
    ],
    "provisioners": [
        {
            "type": "file",
            "source": "{{user `init_path`}}/init.sh",
            "destination": "/usr/bin/init_ha.sh"
        },
        {
            "type": "ansible-local",
            "playbook_file": "{{ user `playbook` }}",
            "command": "ANSIBLE_FORCE_COLOR=1 PYTHONUNBUFFERED=1 INIT_PATH={{user `init_path`}} ansible-playbook -i '{{ user `img_mount_path` }}'"
        },
        {
            "type": "shell",
            "inline": [
                "chmod +x /usr/bin/init_ha.sh"
            ]
        },
        {
            "type": "shell",
            "inline": [
                "/usr/bin/init_ha.sh"
            ]
        }
    ]
}